events {
	worker_connections 1024;
}

http {
	include /etc/nginx/mime.types;
	default_type application/octet-stream;
	
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;
	
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	
	client_max_body_size 10M;
	
	upstream backend {
		server backend:3000;
	}

	server {
		listen 443 ssl;
		server_name olomova.42.fr;
		
		ssl_certificate /etc/nginx/cert/olomova.42.fr.crt;
		ssl_certificate_key /etc/nginx/cert/olomova.42.fr.key;
	
		root /usr/share/nginx/html;
		index index.html;
	
		# API endpoints
		location ~ ^/(registration|login|logout|profile|avatar)$ {
			proxy_pass http://backend;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto https;
			proxy_cache_bypass $http_upgrade;
		}
	
		location /uploads/ {
			alias /usr/share/nginx/html/uploads/;
			expires 1y;
			add_header Cache-Control "public, immutable";
		}
	
		# Static files
		location / {
			try_files $uri $uri/ =404;
		}
	
		# Cache static
		location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
			expires 1y;
			add_header Cache-Control "public, immutable";
		}
	}
	# Redirect HTTP â†’ HTTPS
	server {
		listen 80;
		server_name olomova.42.fr;
		return 301 https://$host$request_uri;
	}
}
